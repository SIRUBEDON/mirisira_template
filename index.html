<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ミリしらメーカー</title>

    <!-- SEO and OGP Meta Tags -->
    <meta name="description" content="「1ミリも知らない」あの作品のキャラクターの予想図を自由に作って遊べるWebツール。画像のアップロードやレイアウト調整、フォント変更など豊富な機能でオリジナルのミリしらテンプレが簡単に作れます。">
    <meta name="keywords" content="ミリしら,ミリしらメーカー,ミリしらテンプレ,ジェネレーター,相関図,お絵かき,アニメ,漫画,ゲーム">
    
    <!-- OGP (Open Graph Protocol) Tags -->
    <meta property="og:title" content="ミリしらメーカー">
    <meta property="og:description" content="画像のアップロードやレイアウト調整、フォント変更など豊富な機能でオリジナルの「ミリしら」テンプレが簡単に作れるWebツールです。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/mirishira-maker/"> <!-- TODO: 公開するURLに書き換えてください -->
    <meta property="og:image" content="https://placehold.co/1200x630/4f46e5/ffffff?text=%E3%83%9F%E3%83%AA%E3%81%97%E3%82%89%E3%83%A1%E3%83%BC%E3%82%AB%E3%83%BC"> <!-- TODO: プレビュー画像のURLに書き換えてください -->
    <meta property="og:site_name" content="ミリしらメーカー">
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas (画像化ライブラリ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- SortableJS (ドラッグ&ドロップライブラリ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Google Fonts Link (動的に変更) -->
    <link id="google-font-link" rel="stylesheet" href="">
    <style>
        :root {
            --border-width: 1px;
            --header-border-width: 2px;
        }
        /* 印刷時や画像化する際に不要な要素を非表示にする */
        @media print { .no-print { display: none; } body { background-color: #fff; } #sheet { box-shadow: none; border: none; } }
        
        .image-placeholder {
            cursor: pointer;
            transition: background-color 0.3s;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        .image-placeholder:hover { background-color: #e0e0e0; }

        /* 線の太さをCSS変数で管理 */
        .styled-input, .styled-textarea {
            border: var(--border-width) solid #4B5563; /* gray-600 */
            background-color: #F9FAFB; /* gray-50 */
            width: 100%; padding: 4px 8px; font-size: 14px;
        }
        .styled-input { height: 30px; border-radius: 4px; }
        .styled-textarea { height: 80px; resize: none; border-radius: 4px; }

        .custom-file-button {
            background-color: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem;
            cursor: pointer; font-weight: 600; transition: background-color 0.2s;
        }
        .custom-file-button:hover { background-color: #4338ca; }

        /* ドラッグ中のスタイル */
        .sortable-ghost { opacity: 0.4; background: #c7d2fe; }
        
        /* 画像位置調整ボタンのスタイル */
        .image-pos-controls {
            position: absolute;
            bottom: 4px;
            right: 4px;
            display: none; /* 最初は非表示 */
            gap: 2px;
        }
        .image-pos-controls button {
            width: 24px; height: 24px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none; border-radius: 50%;
            font-size: 16px; line-height: 24px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .image-pos-controls button:hover { background-color: rgba(0, 0, 0, 0.8); }
        .card-with-image .image-pos-controls { display: flex; } /* 画像があると表示 */
    </style>
</head>
<body class="p-4 sm:p-8" style="background-color: #f3f4f6;">

    <div class="max-w-4xl mx-auto">
        <!-- 操作パネル -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-8 no-print">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">ミリしらメーカー</h1>
            
            <!-- 1. タイトル設定 -->
            <fieldset class="border-t border-gray-300 pt-4 mb-6">
                <legend class="text-lg font-semibold text-gray-800 px-2">1. タイトル設定</legend>
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <div>
                        <label for="title-text" class="block text-sm font-medium text-gray-700 mb-1">作品タイトル (テキスト)</label>
                        <input type="text" id="title-text" class="w-full border-gray-300 rounded-md shadow-sm" placeholder="ここにタイトルを入力">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="title-image" class="block text-sm font-medium text-gray-700 mb-1">タイトル画像 (ロゴなど)</label>
                            <div class="flex items-center gap-2">
                                <input type="file" id="title-image" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                                <button id="clear-title-image-btn" class="px-3 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-sm hover:bg-red-600 text-sm flex-shrink-0" title="タイトル画像を消去">消去</button>
                            </div>
                        </div>
                        <div>
                            <label for="logo-suffix-text" class="block text-sm font-medium text-gray-700 mb-1">ロゴ後のテキスト</label>
                            <input type="text" id="logo-suffix-text" class="w-full border-gray-300 rounded-md shadow-sm" value="ミリしらテンプレ">
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- 2. キャラクター数設定 -->
            <fieldset class="border-t border-gray-300 pt-4 mb-6">
                <legend class="text-lg font-semibold text-gray-800 px-2">2. キャラクター数設定</legend>
                <div class="flex items-center justify-center gap-4 mt-4">
                    <span class="text-sm font-medium text-gray-700">キャラクター数:</span>
                    <button id="remove-card-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600">-</button>
                    <span id="card-count" class="text-lg font-bold">8</span>
                    <button id="add-card-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600">+</button>
                </div>
            </fieldset>

            <!-- 3. デザイン調整 -->
            <fieldset class="border-t border-gray-300 pt-4 mb-6">
                <legend class="text-lg font-semibold text-gray-800 px-2">3. デザイン調整</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="flex items-center justify-center gap-2">
                        <label for="border-width-slider" class="text-sm font-medium text-gray-700">線の太さ:</label>
                        <input type="range" id="border-width-slider" min="1" max="5" value="1" class="w-32">
                        <span id="border-width-value" class="w-8 text-right">1px</span>
                    </div>
                    <div class="flex items-center justify-center gap-2">
                        <label for="font-select" class="text-sm font-medium text-gray-700">フォント:</label>
                        <select id="font-select" class="w-40 border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                </div>
            </fieldset>

            <!-- 4. プロジェクト管理 -->
            <fieldset class="border-t border-gray-300 pt-4 mb-6">
                <legend class="text-lg font-semibold text-gray-800 px-2">4. プロジェクト管理</legend>
                <div class="flex flex-col md:flex-row items-center justify-center gap-4 mt-4">
                    <button id="save-project-btn" class="w-full md:w-auto custom-file-button bg-teal-600 hover:bg-teal-700">プロジェクトを保存</button>
                    <label for="load-project-input" class="w-full md:w-auto custom-file-button">プロジェクトを読込</label>
                    <input type="file" id="load-project-input" class="hidden" accept=".json">
                </div>
            </fieldset>

            <!-- 5. 完成 -->
            <fieldset class="border-t border-gray-300 pt-4 mb-6">
                 <legend class="text-lg font-semibold text-gray-800 px-2">5. 完成</legend>
                <div class="text-center mt-4">
                    <button id="download-btn" class="w-full md:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700">完成したシートを画像としてダウンロード</button>
                </div>
            </fieldset>

            <!-- 6. このツールについて -->
            <fieldset class="border-t border-gray-300 pt-4">
                <legend class="text-lg font-semibold text-gray-800 px-2">6. このツールについて</legend>
                <div class="text-sm text-gray-600 mt-4 px-2">
                    <p class="mb-2">
                        作成者: <a href="https://x.com/qxoiUioxp" target="_blank" class="text-indigo-600 hover:underline">しるべ(@qxoiUioxp)</a>
                    </p>
                    <div>
                        <h4 class="font-semibold mb-1">更新履歴</h4>
                        <ul class="list-disc list-inside">
                            <li>2025/07/20: 公開</li>
                        </ul>
                    </div>
                </div>
            </fieldset>
        </div>

        <!-- ミリしらシート本体 -->
        <div id="sheet" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
            <header id="sheet-header" class="flex justify-between items-center border-b-2 pb-4 mb-6" style="border-color: #374151;">
                <div id="sheet-title" class="flex items-center gap-4 text-3xl sm:text-4xl font-bold text-gray-800">ミリしらシート</div>
                <div class="flex items-center gap-2">
                    <span class="font-semibold text-gray-700">やった人:</span>
                    <input type="text" id="player-name" class="border-b-2 focus:outline-none w-32 sm:w-48" style="border-color: #374151;">
                </div>
            </header>
            <main id="character-grid" class="grid grid-cols-4 gap-4">
                <!-- キャラクターカードはJavaScriptでここに追加されます -->
            </main>
        </div>
    </div>

    <script>
        // === DOM要素の取得 ===
        const sheet = document.getElementById('sheet');
        const googleFontLink = document.getElementById('google-font-link');
        const fontSelect = document.getElementById('font-select');
        const titleTextInput = document.getElementById('title-text');
        const titleImageInput = document.getElementById('title-image');
        const logoSuffixTextInput = document.getElementById('logo-suffix-text');
        const clearTitleImageBtn = document.getElementById('clear-title-image-btn');
        const sheetTitle = document.getElementById('sheet-title');
        const playerNameInput = document.getElementById('player-name');
        const addCardBtn = document.getElementById('add-card-btn');
        const removeCardBtn = document.getElementById('remove-card-btn');
        const cardCountSpan = document.getElementById('card-count');
        const characterGrid = document.getElementById('character-grid');
        const borderWidthSlider = document.getElementById('border-width-slider');
        const borderWidthValue = document.getElementById('border-width-value');
        const saveProjectBtn = document.getElementById('save-project-btn');
        const loadProjectInput = document.getElementById('load-project-input');
        const downloadBtn = document.getElementById('download-btn');

        // フォントリスト
        const fonts = [
            { name: 'デフォルト (ゴシック体)', family: 'sans-serif' },
            { name: 'Noto Sans JP', family: 'Noto Sans JP' },
            { name: 'M PLUS Rounded 1c', family: 'M PLUS Rounded 1c' },
            { name: 'Yusei Magic', family: 'Yusei Magic' },
            { name: 'RocknRoll One', family: 'RocknRoll One' },
            { name: 'DotGothic16', family: 'DotGothic16' },
            { name: 'Kaisei Opti', family: 'Kaisei Opti' },
            { name: 'デフォルト (明朝体)', family: 'serif' }
        ];

        // === 初期化 ===
        const initialize = () => {
            populateFontSelector();
            for (let i = 0; i < 8; i++) {
                characterGrid.appendChild(createCharacterCard());
            }
            updateCardCount();
            new Sortable(characterGrid, { animation: 150, ghostClass: 'sortable-ghost' });
        };

        // === 機能の実装 ===

        // フォントセレクター設定
        const populateFontSelector = () => {
            fonts.forEach(font => {
                const option = document.createElement('option');
                option.value = font.family;
                option.textContent = font.name;
                fontSelect.appendChild(option);
            });
        };
        
        const changeFont = (fontFamily) => {
            if (fontFamily === 'sans-serif' || fontFamily === 'serif') {
                googleFontLink.href = '';
            } else {
                const fontUrl = `https://fonts.googleapis.com/css2?family=${fontFamily.replace(/ /g, '+')}&display=swap`;
                googleFontLink.href = fontUrl;
            }
            sheet.style.fontFamily = `'${fontFamily}', sans-serif`;
        };
        fontSelect.addEventListener('input', (e) => changeFont(e.target.value));

        // 1. タイトル設定機能
        titleTextInput.addEventListener('input', (e) => {
            const text = e.target.value;
            sheetTitle.innerHTML = '';
            sheetTitle.textContent = text || 'ミリしらシート';
        });

        const buildTitleWithLogo = (imgSrc) => {
            sheetTitle.innerHTML = '';
            const img = document.createElement('img');
            img.src = imgSrc;
            img.className = 'max-h-16 w-auto';
            const suffixText = logoSuffixTextInput.value;
            sheetTitle.appendChild(img);
            if (suffixText) {
                const textSpan = document.createElement('span');
                textSpan.textContent = suffixText;
                textSpan.className = 'text-xl font-medium';
                sheetTitle.appendChild(textSpan);
            }
            titleTextInput.value = '';
        };

        titleImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => buildTitleWithLogo(event.target.result);
                reader.readAsDataURL(file);
            }
        });

        logoSuffixTextInput.addEventListener('input', () => {
            const logoImg = sheetTitle.querySelector('img');
            if (logoImg) {
                buildTitleWithLogo(logoImg.src);
            }
        });

        clearTitleImageBtn.addEventListener('click', () => {
            sheetTitle.innerHTML = '';
            sheetTitle.textContent = titleTextInput.value || 'ミリしらシート';
            titleImageInput.value = '';
        });

        // 2. キャラクターカード作成機能
        const createCharacterCard = () => {
            const card = document.createElement('div');
            card.className = 'border rounded-md p-2 flex flex-col gap-2';
            card.style.borderColor = '#4B5563';
            card.style.borderWidth = 'var(--border-width)';

            card.innerHTML = `
                <div class="image-placeholder w-full h-32 bg-gray-200 rounded relative">
                    <span class="text-xs text-center p-1">クリックして画像を選択</span>
                    <div class="image-pos-controls">
                        <button data-axis="y" data-dir="-1" title="上に移動">↑</button>
                        <button data-axis="y" data-dir="1" title="下に移動">↓</button>
                        <button data-axis="x" data-dir="-1" title="左に移動">←</button>
                        <button data-axis="x" data-dir="1" title="右に移動">→</button>
                    </div>
                </div>
                <input type="file" accept="image/*" class="hidden">
                <input type="text" class="styled-input" readonly>
                <textarea class="styled-textarea" readonly></textarea>
            `;
            
            const imagePlaceholder = card.querySelector('.image-placeholder');
            const fileInput = card.querySelector('input[type="file"]');
            const placeholderText = card.querySelector('span');

            imagePlaceholder.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    fileInput.click();
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePlaceholder.style.backgroundImage = `url('${event.target.result}')`;
                        placeholderText.classList.add('hidden');
                        card.classList.add('card-with-image');
                    };
                    reader.readAsDataURL(file);
                }
            });

            card.querySelector('.image-pos-controls').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const axis = e.target.dataset.axis;
                    const dir = parseInt(e.target.dataset.dir, 10);
                    const currentPos = getComputedStyle(imagePlaceholder).backgroundPosition.split(' ');
                    let [x, y] = currentPos.map(p => parseFloat(p));

                    if (axis === 'x') x += dir * 5;
                    else y += dir * 5;
                    imagePlaceholder.style.backgroundPosition = `${x}% ${y}%`;
                }
            });
            return card;
        };
        
        // 3. カード数の増減機能
        const updateCardCount = () => {
            cardCountSpan.textContent = characterGrid.children.length;
        };

        addCardBtn.addEventListener('click', () => {
            characterGrid.appendChild(createCharacterCard());
            updateCardCount();
        });

        removeCardBtn.addEventListener('click', () => {
            if (characterGrid.children.length > 1) {
                characterGrid.removeChild(characterGrid.lastChild);
                updateCardCount();
            }
        });

        // 4. 線の太さ調整機能
        borderWidthSlider.addEventListener('input', (e) => {
            const width = e.target.value;
            document.documentElement.style.setProperty('--border-width', `${width}px`);
            document.documentElement.style.setProperty('--header-border-width', `${Number(width) + 1}px`);
            borderWidthValue.textContent = `${width}px`;
        });

        // 5. プロジェクト保存機能
        saveProjectBtn.addEventListener('click', () => {
            const cardsData = [];
            characterGrid.querySelectorAll('.border').forEach(card => {
                cardsData.push({
                    imageSrc: card.querySelector('.image-placeholder').style.backgroundImage.slice(5, -2),
                    bgPos: card.querySelector('.image-placeholder').style.backgroundPosition
                });
            });

            const projectData = {
                titleText: titleTextInput.value,
                titleHTML: sheetTitle.innerHTML,
                logoSuffixText: logoSuffixTextInput.value,
                playerName: playerNameInput.value,
                borderWidth: borderWidthSlider.value,
                fontFamily: fontSelect.value,
                cards: cardsData
            };

            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'mirishira-project.json';
            link.click();
            URL.revokeObjectURL(link.href);
        });

        // 6. プロジェクト読み込み機能
        loadProjectInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    titleTextInput.value = data.titleText || '';
                    logoSuffixTextInput.value = data.logoSuffixText !== undefined ? data.logoSuffixText : 'ミリしらテンプレ';
                    sheetTitle.innerHTML = data.titleHTML || 'ミリしらシート';
                    playerNameInput.value = data.playerName || '';
                    borderWidthSlider.value = data.borderWidth || 1;
                    borderWidthSlider.dispatchEvent(new Event('input'));
                    
                    const selectedFont = data.fontFamily || 'sans-serif';
                    fontSelect.value = selectedFont;
                    changeFont(selectedFont);

                    characterGrid.innerHTML = '';
                    data.cards.forEach(cardData => {
                        const newCard = createCharacterCard();
                        if (cardData.imageSrc) {
                            const placeholder = newCard.querySelector('.image-placeholder');
                            placeholder.style.backgroundImage = `url('${cardData.imageSrc}')`;
                            placeholder.style.backgroundPosition = cardData.bgPos || 'center';
                            newCard.querySelector('span').classList.add('hidden');
                            newCard.classList.add('card-with-image');
                        }
                        characterGrid.appendChild(newCard);
                    });
                    updateCardCount();

                } catch (error) {
                    console.error("プロジェクト読込失敗:", error);
                    alert("無効なプロジェクトファイルです。");
                }
            };
            reader.readAsText(file);
            loadProjectInput.value = '';
        });

        // 7. 画像ダウンロード機能
        downloadBtn.addEventListener('click', () => {
            downloadBtn.textContent = '画像生成中...';
            downloadBtn.disabled = true;

            document.querySelectorAll('.image-pos-controls').forEach(el => el.style.display = 'none');

            html2canvas(sheet, {
                scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'mirishira_sheet.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('画像生成失敗:', err);
                alert('エラーが発生しました。');
            }).finally(() => {
                document.querySelectorAll('.card-with-image .image-pos-controls').forEach(el => el.style.display = 'flex');
                downloadBtn.textContent = '完成したシートを画像としてダウンロード';
                downloadBtn.disabled = false;
            });
        });

        initialize();
    </script>
</body>
</html>
